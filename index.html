<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    
    <title>Museum Lichtenberg</title>
    
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Colors */
            --bg-color: #050505; --text-main: #ffffff;
            --c-erinnerung: #D4AF37;   /* Gold */
            --c-gedenken: #A0A0A0;     /* Silver */
            --c-widerstand: #00E676;   /* Neon Green */
            --c-heute: #FF3D00;        /* Neon Red */
            --c-path: #00FFFF;         /* Cyan Path */

            /* Fonts */
            --font-head: 'Space Grotesk', sans-serif; --font-body: 'Inter', sans-serif;
            --sidebar-width: 500px;
        }

        body { margin: 0; padding: 0; background: var(--bg-color); color: var(--text-main); font-family: var(--font-body); overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }

        /* --- START SCREEN --- */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(10px);
        }
        .start-btn {
            background: var(--c-widerstand); color: black; border: none;
            padding: 15px 50px; border-radius: 30px;
            font-family: var(--font-head); font-weight: bold; font-size: 1.2rem;
            cursor: pointer; margin-top: 30px;
            box-shadow: 0 0 30px var(--c-widerstand);
            transition: transform 0.2s;
        }
        .start-btn:active { transform: scale(0.95); }

        /* --- MINI SCANNER (Positioned Lower) --- */
        #mini-scanner {
            position: absolute; 
            top: 260px; /* Position tiefer */
            left: 30px; 
            width: 120px; height: 120px; 
            background: #000;
            border: 2px solid #444;
            border-radius: 12px;
            overflow: hidden;
            z-index: 50;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            transition: border-color 0.3s;
        }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        
        .scanner-label {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.6); color: #aaa;
            font-size: 9px; text-align: center; padding: 3px;
            font-family: var(--font-head); letter-spacing: 1px;
            pointer-events: none;
        }

        /* Overlay bei Treffer */
        #scan-hit-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 230, 118, 0.95); /* Green */
            display: none; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .hit-icon { font-size: 24px; color: black; font-weight: bold; }
        .hit-text { font-size: 10px; color: black; font-family: var(--font-head); font-weight: bold; margin-top: 2px; }

        /* UI LAYER */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .vignette-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; background: radial-gradient(circle at center, transparent 30%, rgba(0,0,0,0.8) 60%, rgba(0,0,0,1) 90%); }
        
        header { position: absolute; top: 30px; left: 30px; pointer-events: auto; text-shadow: 0 0 10px rgba(0,0,0,0.8); }
        .museum-label { font-family: var(--font-head); font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase; color: #aaa; margin-bottom: 5px; font-weight: 500; border-left: 3px solid var(--c-widerstand); padding-left: 10px; }
        h1 { font-family: var(--font-head); font-size: 3rem; margin: 0; line-height: 0.9; font-weight: 700; color: white; letter-spacing: -1px; }

        #timeline-ui { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 80%; max-width: 900px; min-width: 320px; pointer-events: auto; text-align: center; background: rgba(10, 10, 10, 0.85); padding: 15px 40px; border-radius: 40px; border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(8px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #year-display { font-family: var(--font-head); font-size: 2.5rem; font-weight: 700; display: block; margin-bottom: 5px; line-height: 1; color: white; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #444; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #fff; border: 2px solid #000; margin-top: -8px; transition: transform 0.1s; }
        .ticks { display: flex; justify-content: space-between; width: 100%; margin-top: 10px; font-size: 0.8rem; color: #ccc; text-transform: uppercase; letter-spacing: 1px; font-family: var(--font-head); }
        .ticks span { text-align: center; flex: 1; }
        .ticks span:first-child { text-align: left; }
        .ticks span:last-child { text-align: right; }

        #status-panel { position: absolute; top: 30px; right: 30px; width: 240px; pointer-events: auto; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .status-header { font-size: 0.7rem; text-transform: uppercase; color: #888; letter-spacing: 1px; }
        .progress-bar { width: 100%; height: 4px; background: #333; margin-top: 8px; border-radius: 2px; }
        .progress-fill { height: 100%; background: var(--c-widerstand); width: 0%; transition: width 0.5s; box-shadow: 0 0 8px var(--c-widerstand); }
        .lock-text { text-align: right; font-family: var(--font-head); font-size: 0.9rem; color: #666; margin-top: 5px; }

        #legend { position: absolute; bottom: 30px; left: 30px; pointer-events: auto; display: flex; flex-direction: column; gap: 8px; }
        .legend-item { display: flex; align-items: center; gap: 10px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #ccc; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }

        #sidebar { position: absolute; right: 0; top: 0; bottom: 0; width: var(--sidebar-width); background: #080808; border-left: 1px solid #333; z-index: 60; transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); overflow-y: auto; pointer-events: auto; display: flex; flex-direction: column; box-shadow: -20px 0 50px rgba(0,0,0,0.8); }
        #sidebar.open { transform: translateX(0); }
        .close-area { position: sticky; top: 0; width: 100%; height: 70px; z-index: 50; display: flex; justify-content: flex-end; align-items: center; padding-right: 25px; background: linear-gradient(to bottom, rgba(8,8,8,1) 50%, rgba(8,8,8,0)); }
        .close-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; width: 44px; height: 44px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .close-btn:hover { background: white; color: black; }
        .sidebar-content { padding: 40px; padding-top: 0; }
        .hero-img { width: 100%; height: 300px; object-fit: cover; border-bottom: 4px solid #333; margin-bottom: 25px; }
        .cat-tag { font-family: var(--font-head); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; display: inline-block; padding: 4px 8px; border: 1px solid #444; color: #fff; }
        h2 { font-family: var(--font-head); font-size: 2.2rem; line-height: 1.1; margin: 0 0 25px 0; font-weight: 700; color: white; }
        .article { font-size: 1.05rem; line-height: 1.7; color: #ccc; font-weight: 300; margin-bottom: 40px; }
        .article h3 { color: white; font-family: var(--font-head); font-size: 1.2rem; margin-top: 30px; margin-bottom: 10px; font-weight: 500; border-left: 3px solid var(--c-path); padding-left: 10px; }
        .source { font-size: 0.75rem; color: #666; border-top: 1px solid #222; padding-top: 20px; font-style: italic; }
        .locked-view { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px; color: #555; }
        .locked-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }
        .footer-note { font-size: 0.8rem; color: #888; margin-top: 30px; border-top: 1px solid #333; padding-top: 15px; }

        @media (max-width: 1024px) {
            :root { --sidebar-width: 100%; }
            #timeline-ui { width: 90%; bottom: 20px; padding: 15px 20px; }
            .sidebar-content { padding: 25px; }
            #mini-scanner { top: 120px; left: 20px; } 
        }
        .mapboxgl-popup-content { background: #000; color: #fff; border: 1px solid #444; font-family: var(--font-body); padding: 10px 14px; }
        .mapboxgl-popup-close-button { display: none; }
    </style>
</head>
<body class="p-1933">

    <div id="start-screen">
        <h1 style="color:white; margin-bottom: 10px; text-shadow:0 0 20px black;">Museum Lichtenberg</h1>
        <p style="color:#aaa; font-family:var(--font-head);">Orte des Widerstands</p>
        <button class="start-btn" onclick="startExhibition()">Ausstellung Starten</button>
    </div>

    <div id="map"></div>
    <div class="vignette-overlay"></div>

    <div id="ui-layer">
        <header>
            <div class="museum-label">Museum Lichtenberg</div>
            <h1>Orte des<br>Widerstands</h1>
        </header>

        <div id="mini-scanner">
            <div id="reader"></div>
            <div class="scanner-label">SCAN QR</div>
            
            <div id="scan-hit-overlay" onclick="executeScanAction()">
                <div class="hit-icon">‚ûú</div>
                <div class="hit-text">√ñFFNEN</div>
            </div>
        </div>

        <div id="status-panel">
            <div class="status-header">Archiv Fortschritt</div>
            <div class="progress-bar"><div class="progress-fill" id="progress-bar"></div></div>
            <div class="lock-text" id="lock-status">GEGENWART GESPERRT</div>
        </div>

        <div id="legend">
            <div class="legend-item"><div class="dot" style="background:var(--c-erinnerung)"></div> Orte der Erinnerung</div>
            <div class="legend-item"><div class="dot" style="background:var(--c-gedenken)"></div> Gedenken</div>
            <div class="legend-item"><div class="dot" style="background:var(--c-widerstand)"></div> Widerstand</div>
            <div class="legend-item"><div class="dot" style="background:var(--c-heute)"></div> Gegen Rechts Heute</div>
        </div>

        <div id="timeline-ui">
            <span id="year-display">1933</span>
            <input type="range" id="year-slider" min="1933" max="2026" value="1933" step="1">
            <div class="ticks">
                <span>1933</span><span>1990</span><span>2000</span><span>Heute</span>
            </div>
        </div>
    </div>

    <div id="sidebar">
        <div class="close-area"><button class="close-btn" onclick="closeSidebar()">&times;</button></div>
        <div id="sidebar-content"></div>
    </div>

    <script>
        // ------------------------------------------------------------------
        // CONFIG
        // ------------------------------------------------------------------
        mapboxgl.accessToken = 'pk.eyJ1IjoiaWxpYXNtZXJhYmloYSIsImEiOiJjbWxndXhkeHYwMjZwM2RxdmlmbW41MmVlIn0.pb_GFtsw_uGl7eOkRZfKvw'; 

        const geoData = {
            'type': 'FeatureCollection',
            'features': [
                // === KATEGORIE 1: ORTE DER ERINNERUNG (Opfer & Widerstandsk√§mpfer:innen) ===
                {
                    'type': 'Feature',
                    'properties': {
                        [cite_start]'id': 'kurt_schneider', 'category': 'erinnerung', 'title': 'Kurt Schneider (1961‚Äì1999) [cite: 13]', 'year': 1999,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/0/01/Memorial_plaque_metal_Kurt_Schneider_Berlin%2C_Germany.jpg',
                        'description': `<h3>Opfer rechter Gewalt</h3><p>Kurt Schneider wurde 1961 in K√∂nigs Wusterhausen geboren. Er arbeitete als Maurer. In der Nacht zum 6. Oktober 1999 wurde er von vier Neonazis √ºberfallen, weil sie seinen Gru√ü als "Beleidigung" empfanden. [cite_start]Sie schlugen ihn zusammen, kehrten sp√§ter mit einem Messer zur√ºck und ermordeten ihn[cite: 17, 18].</p><h3>Kontext</h3><p>Vor Gericht gaben die T√§ter an, ihn als "minderwertigen Menschen" angesehen zu haben. Das Gericht erkannte zun√§chst kein politisches Motiv. [cite_start]Erst 2018 wurde die Tat durch eine TU-Studie offiziell als rechtsextremer Gewaltakt anerkannt[cite: 22, 25].</p>`,
                        'source': 'Gedenktafeln in Berlin - Kurt Schneider'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4802, 52.5185] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        [cite_start]'id': 'silvio_meier', 'category': 'erinnerung', 'title': 'Silvio Meier (1965‚Äì1992) [cite: 30]', 'year': 1992,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/1/14/Silvio_Meier.jpg',
                        'description': `<h3>Aktivist & Opfer</h3><p>Aktiv in der DDR-Opposition (Kirche von Unten, Umweltbibliothek). [cite_start]Nach der Wende Hausbesetzer in der Schreinerstra√üe 47. Wurde 1992 aufgrund seines antifaschistischen Auftretens von Neonazis im U-Bahnhof Samariterstra√üe ermordet[cite: 37, 39].</p><h3>Gedenken</h3><p>J√§hrliche Gedenkdemonstration (1992‚Äì2014). [cite_start]Gedenktafel am U-Bhf Samariterstra√üe (fest verankert 2007) und Umbenennung der Gabelsbergerstra√üe in Silvio-Meier-Stra√üe (2013)[cite: 46, 49].</p>`,
                        'source': 'Amadeu Antonio Stiftung - Silvio Meier'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4658, 52.5144] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        [cite_start]'id': 'eugeniu_botnari', 'category': 'erinnerung', 'title': 'Eugeniu Botnari (1982‚Äì2016) [cite: 52]', 'year': 2016,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/0/03/Gedenktafel_Eugeniu-Botnari-Platz_%28Rumbg%29_Eugeniu_Botnari.jpg',
                        'description': `<h3>Opfer rassistischer Gewalt</h3><p>Wurde am 17. September 2016 vom Filialleiter eines Edeka-Marktes des Ladendiebstahls bezichtigt, in ein Lager gezerrt und mit Quarzhandschuhen verpr√ºgelt. [cite_start]Botnari starb Tage sp√§ter an einem Sch√§del-Hirn-Trauma[cite: 57, 61].</p><h3>Kontext</h3><p>Der T√§ter filmte die Tat und teilte sie mit menschenverachtenden Kommentaren. Motiv war Sozialdarwinismus (Hass auf Obdachlose) und Rassismus. [cite_start]Im April 2023 wurde der Platz nach Botnari benannt[cite: 64, 71].</p>`,
                        'source': 'Amadeu Antonio Stiftung - Eugeniu Botnari'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4975, 52.5098] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        [cite_start]'id': 'kaethe_tucholla', 'category': 'erinnerung', 'title': 'K√§the Tucholla (1910‚Äì1943) [cite: 74]', 'year': 1943,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/5/5c/Kaskelkiez_Kaskelstr_Gedenktafel_Tucholla.JPG',
                        'description': `<h3>Widerstandsk√§mpferin</h3><p>Sekret√§rin und Hockeyspielerin bei Sparta Lichtenberg. Engagierte sich mit ihrem Mann Felix in der KPD-Widerstandsgruppe um Robert Uhrig. [cite_start]Verbreitete Flugbl√§tter und unterst√ºtzte Fallschirmj√§ger[cite: 79, 83].</p><h3>Schicksal</h3><p>Festnahme am 25. Juli 1942. Zum Tode verurteilt wegen "Vorbereitung zum Hochverrat". [cite_start]Ermordet am 28. September 1943 in Pl√∂tzensee[cite: 87, 89].</p>`,
                        'source': 'Frauen im Widerstand gegen den Nationalsozialismus - K√§the Tucholla'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4832, 52.5038] }
                },

                // === KATEGORIE 3: ORTE DES GEDENKENS (Historische Orte) ===
                {
                    'type': 'Feature',
                    'properties': {
                        [cite_start]'id': 'rummelsburg', 'category': 'gedenken', 'title': 'Gedenkort Rummelsburg (1933‚Äì1990) [cite: 139]', 'year': 1933,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/5/52/Bundesarchiv_Bild_183-1990-0704-026%2C_Berlin%2C_Rummelsburg%2C_M%C3%A4nnerhaftanstalt.jpg',
                        'description': `<h3>Verfolgung und Haft</h3><p>1879 als Arbeitshaus er√∂ffnet. Im NS-Staat Verfolgung von "Asozialen"; 1941 Deportation j√ºdischer Insassen zur Ermordung (Aktion T4). [cite_start]In der DDR Nutzung als Gef√§ngnis (auch f√ºr politische H√§ftlinge)[cite: 143, 146, 152].</p><h3>Status heute</h3><p>Gedenkort seit 2015; [cite_start]Geb√§ude zu Wohnraum umgebaut[cite: 154, 155].</p>`,
                        'source': 'Memorial Museums - Gedenkort Rummelsburg'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4855, 52.4955] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        [cite_start]'id': 'rote_kapelle', 'category': 'gedenken', 'title': 'Die Rote Kapelle (1940‚Äì1942) [cite: 157]', 'year': 1940,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/c/ca/Skulptur_Schulze-Boysen-Str_12_%28Liber%29_B%C3%BCrger_im_Widerstand%26Achim_K%C3%BChn%2620112.jpg',
                        'description': `<h3>Widerstandsnetzwerk</h3><p>Gro√ües antifaschistisches Widerstandsnetzwerk (√ºber 150 Personen). [cite_start]Dokumentierten NS-Verbrechen und warnten die Sowjetunion vor Angriffen[cite: 162, 166].</p><h3>Verfolgung</h3><p>1942 Verhaftungswelle, √ºber 50 Todesurteile/Ermordungen. [cite_start]Stra√üen und Schulen im Kiez tragen Namen der Mitglieder (Coppi, Harnack, Schulze-Boysen)[cite: 167, 169].</p>`,
                        'source': 'Gedenktafeln in Berlin'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4872, 52.5138] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        [cite_start]'id': 'loeperplatz', 'category': 'gedenken', 'title': 'Ehrenmal Loeperplatz [cite: 174]', 'year': 1948,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/f/fe/Loeperplatz_VDN_1.jpg',
                        'description': `<h3>Opfer des Faschismus</h3><p>Vermutlich 1948 errichtet. [cite_start]Steinquader mit roter Pyramide und den Buchstaben "KZ" (symbolisiert den roten Winkel der politischen H√§ftlinge)[cite: 179, 183].</p>`,
                        'source': 'Memorial Museums'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4795, 52.5238] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        [cite_start]'id': 'rathaus', 'category': 'gedenken', 'title': 'Rathaus Lichtenberg (Gedenktafel) [cite: 189]', 'year': 1933,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/0/02/Rathaus_Lichtenberg_West-_und_Hauptfassade_2021.jpg',
                        'description': `<h3>Verfolgte Politiker</h3><p>Erinnert an Bezirks- und Stadtverordnete, die 1933 ihrer √Ñmter enthoben wurden. [cite_start]Darunter Frieda Rosenthal (Suizid in Haft) und Johannes Fest (Berufsverbot)[cite: 196, 202, 206].</p>`,
                        'source': 'Bezirksamt Lichtenberg'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4798, 52.5155] }
                },

                // === KATEGORIE 2: ORTE DES WIDERSTANDS (Aktuelle Initiativen) ===
                {
                    'type': 'Feature',
                    'properties': {
                        [cite_start]'id': 'bunter_wind', 'category': 'widerstand', 'title': 'Bunter Wind f√ºr Lichtenberg [cite: 92]', 'year': 2012,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/0/02/Rathaus_Lichtenberg_West-_und_Hauptfassade_2021.jpg', // Placeholder used
                        'description': `<h3>Seit 2012</h3><p>Setzt Impulse f√ºr eine offene, demokratische Gesellschaft. [cite_start]St√§rkt Zusammenhalt und Solidarit√§t gegen Diskriminierung und Ausgrenzung [cite: 93, 94][cite_start].</p><h3>Motto</h3><p>"Solidarisch f√ºr eine starke und lebendige Demokratie!" [cite: 95]</p>`,
                        'source': 'Bunter Wind f√ºr Lichtenberg'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.5055, 52.5115] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        [cite_start]'id': 'licht_blicke', 'category': 'widerstand', 'title': 'Licht-Blicke [cite: 103]', 'year': 2002,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/0/02/Rathaus_Lichtenberg_West-_und_Hauptfassade_2021.jpg', // Placeholder used
                        'description': `<h3>Seit 2002</h3><p>Netzwerkstelle f√ºr Demokratiepartnerschaften. [cite_start]Schnittstelle zwischen Politik, Verwaltung und Zivilgesellschaft [cite: 105, 107][cite_start].</p><h3>Aufgaben</h3><p>Unterst√ºtzung lokalen Engagements gegen Rechts, F√∂rderung von Diversit√§tsbewusstsein, Koordinierung der Stolperstein-Verlegung und Jugendpartizipation[cite: 112, 119].</p>`,
                        'source': 'Licht Blicke'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.5205, 52.4962] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        [cite_start]'id': 'berliner_register', 'category': 'widerstand', 'title': 'Berliner Register [cite: 122]', 'year': 2005,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/0/02/Rathaus_Lichtenberg_West-_und_Hauptfassade_2021.jpg', // Placeholder used
                        [cite_start]'description': `<h3>Seit 2005</h3><p>Dokumentation von Diskriminierung und Ausgrenzung im Alltag (rassistisch, antisemitisch, rechts, etc.)[cite: 124].</p><h3>Methode</h3><p>B√ºrger:innen melden Vorf√§lle (auch solche, die keine Straftaten sind, wie Aufkleber oder Spr√ºche). [cite_start]Diese werden in einer Chronik ver√∂ffentlicht, um Ausgrenzung sichtbar zu machen[cite: 126, 127].</p>`,
                        'source': 'Berliner Register'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.5055, 52.5115] }
                }
            ]
        };

        // ------------------------------------------------------------------
        // 2. STATE
        // ------------------------------------------------------------------
        let state = {
            discovered: [],
            required: 3,
            unlocked: false,
            scanner: null,
            lastScannedId: null
        };

        const map = new mapboxgl.Map({
            container: 'map', style: 'mapbox://styles/mapbox/dark-v11',
            center: [13.485, 52.51], zoom: 12.5, pitch: 45,
            bearing: -10
        });

        // ------------------------------------------------------------------
        // 3. START EXHIBITION (SAFE INIT)
        // ------------------------------------------------------------------
        function startExhibition() {
            // Remove start screen IMMEDIATELY
            document.getElementById('start-screen').style.display = 'none';
            
            // Try init scanner, but don't block app if it fails
            setTimeout(initScanner, 500);
        }

        function initScanner() {
            try {
                state.scanner = new Html5Qrcode("reader");
                const config = { fps: 10, qrbox: { width: 80, height: 80 } }; 
                
                state.scanner.start(
                    { facingMode: "environment" }, 
                    config, 
                    onScanSuccess
                ).catch(err => {
                    console.log("Scanner Error (Camera not allowed?):", err);
                });
            } catch(e) {
                console.log("Scanner Lib Error:", e);
            }
        }

        function onScanSuccess(decodedText) {
            let foundId = null;
            for(let feat of geoData.features) {
                if(decodedText.includes(feat.properties.id)) {
                    foundId = feat.properties.id;
                    break;
                }
            }

            if(foundId && foundId !== state.lastScannedId) {
                state.lastScannedId = foundId;
                state.scanner.pause();
                
                const overlay = document.getElementById('scan-hit-overlay');
                overlay.style.display = 'flex';
                document.getElementById('mini-scanner').style.borderColor = "#00E676";
            }
        }

        function executeScanAction() {
            const id = state.lastScannedId;
            const feature = geoData.features.find(f => f.properties.id === id);
            
            if(feature) {
                if (!state.discovered.includes(id)) {
                    state.discovered.push(id);
                    updateProgress();
                }
                
                if (feature.properties.locked) {
                    unlockAll();
                } else {
                    document.getElementById('year-slider').value = feature.properties.year;
                    document.getElementById('year-display').innerText = feature.properties.year;
                    updateMap(feature.properties.year);
                }
                handleMarker(feature.properties, feature.geometry.coordinates);
            }

            setTimeout(() => {
                document.getElementById('scan-hit-overlay').style.display = 'none';
                document.getElementById('mini-scanner').style.borderColor = "#444";
                state.lastScannedId = null;
                state.scanner.resume();
            }, 1000);
        }

        // ------------------------------------------------------------------
        // 4. MAP LOGIC
        // ------------------------------------------------------------------
        map.on('load', () => {
            map.addSource('path-source', { 'type': 'geojson', 'data': { 'type': 'Feature', 'geometry': { 'type': 'LineString', 'coordinates': [] } } });
            map.addLayer({ 'id': 'path-glow', 'type': 'line', 'source': 'path-source', 'paint': { 'line-color': '#00FFFF', 'line-width': 10, 'line-opacity': 0.3, 'line-blur': 4 } });
            map.addLayer({ 'id': 'path-core', 'type': 'line', 'source': 'path-source', 'paint': { 'line-color': '#00FFFF', 'line-width': 3, 'line-dasharray': [2, 1] } });

            const layers = map.getStyle().layers;
            const labelLayerId = layers.find(l => l.type === 'symbol' && l.layout['text-field']).id;
            map.addLayer({ 'id': '3d-buildings', 'source': 'composite', 'source-layer': 'building', 'filter': ['==', 'extrude', 'true'], 'type': 'fill-extrusion', 'paint': { 'fill-extrusion-color': '#222', 'fill-extrusion-height': ['get', 'height'], 'fill-extrusion-opacity': 0.9 } }, labelLayerId);

            map.addSource('markers', { 'type': 'geojson', 'data': geoData });
            
            map.addLayer({ 
                'id': 'marker-glow', 
                'type': 'circle', 
                'source': 'markers', 
                'paint': { 
                    'circle-radius': 70, 
                    'circle-color': ['match', ['get', 'category'], 'erinnerung', '#D4AF37', 'gedenken', '#A0A0A0', 'widerstand', '#00E676', 'heute', '#FF3D00', '#fff'], 
                    'circle-opacity': 0.5, 'circle-blur': 0.5 
                } 
            });
            map.addLayer({ 'id': 'marker-core', 'type': 'circle', 'source': 'markers', 'paint': { 'circle-radius': 10, 'circle-color': '#fff', 'circle-stroke-width': 2, 'circle-stroke-color': '#000' } });

            map.on('click', 'marker-core', (e) => handleMarker(e.features[0].properties, e.features[0].geometry.coordinates));
            map.on('mouseenter', 'marker-core', () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', 'marker-core', () => map.getCanvas().style.cursor = '');

            const urlParams = new URLSearchParams(window.location.search);
            const evt = urlParams.get('event');
            if(evt) {
                document.getElementById('start-screen').style.display = 'none';
                const t = geoData.features.find(f => f.properties.id === evt);
                if(t) handleMarker(t.properties, t.geometry.coordinates);
            }

            updateMap(1933);
        });

        function handleMarker(props, coords) {
            if (props.locked && !state.unlocked) { openSidebarLocked(); return; }
            if (!state.discovered.includes(props.id) && !props.locked) { state.discovered.push(props.id); updateProgress(); }
            
            const isPortrait = window.innerHeight > window.innerWidth;
            const offset = isPortrait ? [0, -200] : [-200, 0];
            map.flyTo({ center: coords, zoom: 16, pitch: 60, offset: offset, speed: 0.8 });
            openSidebar(props);
        }

        function updateProgress() {
            const pct = Math.min((state.discovered.length / state.required) * 100, 100);
            document.getElementById('progress-bar').style.width = pct + '%';
            if (state.discovered.length >= state.required && !state.unlocked) {
                setTimeout(unlockAll, 1000);
            }
        }

        function unlockAll() {
            state.unlocked = true;
            document.getElementById('lock-status').innerText = "FREIGESCHALTET";
            document.getElementById('lock-status').style.color = "#00E676";
            document.getElementById('progress-bar').style.background = "#00E676";
            document.getElementById('year-slider').value = 2026;
            document.getElementById('year-display').innerText = 2026;
            updateMap(2026);
        }

        const slider = document.getElementById('year-slider');
        slider.addEventListener('input', (e) => {
            const year = parseInt(e.target.value);
            document.getElementById('year-display').innerText = year;
            updateMap(year);
        });

        function updateMap(year) {
            const filter = ['<=', ['get', 'year'], year];
            map.setFilter('marker-glow', filter);
            map.setFilter('marker-core', filter);
            
            const visible = geoData.features.filter(f => f.properties.year <= year);
            visible.sort((a,b) => a.properties.year - b.properties.year);
            const coords = visible.map(f => f.geometry.coordinates);
            if(map.getSource('path-source')) map.getSource('path-source').setData({ 'type': 'Feature', 'geometry': { 'type': 'LineString', 'coordinates': coords } });
        }

        function openSidebar(data) {
            const content = document.getElementById('sidebar-content');
            const colors = { 'erinnerung': '#D4AF37', 'gedenken': '#A0A0A0', 'widerstand': '#00E676', 'heute': '#FF3D00' };
            content.innerHTML = `
                <img src="${data.image}" class="hero-img">
                <div class="sidebar-content">
                    <span class="cat-tag" style="border-color:${colors[data.category]}; color:${colors[data.category]}">${data.category.toUpperCase()}</span>
                    <h2>${data.title}</h2>
                    <div class="article">${data.description}</div>
                    <div class="source">Quelle: ${data.source} ‚Ä¢ Jahr: ${data.year}</div>
                    [cite_start]<div class="footer-note">Anlaufstellen f√ºr Opfer rechter Gewalt: Reach Out Berlin [cite: 208]</div>
                </div>`;
            document.getElementById('sidebar').classList.add('open');
        }

        function openSidebarLocked() {
            document.getElementById('sidebar-content').innerHTML = `<div class="locked-view"><div class="locked-icon">üîí</div><h2 style="color:#FF3D00">DATEN VERSCHL√úSSELT</h2><p>Erforschen Sie erst die Geschichte.</p></div>`;
            document.getElementById('sidebar').classList.add('open');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            map.easeTo({ offset: [0, 0] });
        }
    </script>
</body>
</html>
