<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <title>Orte der Erinnerung, des Widerstands und der Solidarit√§t</title>
    
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #050505; 
            --text-main: #ffffff;
            --c-erinnerung: #D4AF37; /* Gold */
            --c-gedenken: #A0A0A0;   /* Silber */
            --c-widerstand: #00E676; /* Neon Gr√ºn */
            --c-heute: #FF3D00;      /* Neon Rot */
            --c-path: #00FFFF;
            --font-head: 'Space Grotesk', sans-serif;
            --font-body: 'Inter', sans-serif;
            --sidebar-width: 500px;
        }

        body { margin: 0; padding: 0; background: var(--bg-color); color: var(--text-main); font-family: var(--font-body); overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }

        /* START SCREEN */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(10px); text-align: center; padding: 20px;
        }
        .start-btn {
            background: var(--c-widerstand); color: black; border: none;
            padding: 15px 50px; border-radius: 30px;
            font-family: var(--font-head); font-weight: bold; font-size: 1.2rem;
            cursor: pointer; margin-top: 30px;
            box-shadow: 0 0 30px var(--c-widerstand);
            transition: transform 0.2s;
        }
        .start-btn:active { transform: scale(0.95); }

        /* UI LAYER */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .vignette-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; background: radial-gradient(circle at center, transparent 30%, rgba(0,0,0,0.8) 60%, rgba(0,0,0,1) 90%); }
        
        header { position: absolute; top: 30px; left: 30px; pointer-events: auto; text-shadow: 0 0 10px rgba(0,0,0,0.8); z-index: 20; }
        .museum-label { font-family: var(--font-head); font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase; color: #aaa; margin-bottom: 5px; font-weight: 500; border-left: 3px solid var(--c-widerstand); padding-left: 10px; }
        h1 { font-family: var(--font-head); font-size: 2.5rem; margin: 0; line-height: 1.1; font-weight: 700; color: white; letter-spacing: -1px; }

        /* SCANNER */
        #mini-scanner {
            position: absolute; top: 260px; left: 30px; 
            width: 120px; height: 120px; 
            background: #000; border: 2px solid #444; border-radius: 12px;
            overflow: hidden; z-index: 50; pointer-events: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); transition: border-color 0.3s;
        }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        .scanner-label { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.6); color: #aaa; font-size: 9px; text-align: center; padding: 3px; font-family: var(--font-head); letter-spacing: 1px; pointer-events: none; }
        #scan-hit-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 230, 118, 0.95); display: none; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .hit-icon { font-size: 24px; color: black; font-weight: bold; }
        .hit-text { font-size: 10px; color: black; font-family: var(--font-head); font-weight: bold; margin-top: 2px; }

        /* STATUS & LEGEND */
        #status-panel { position: absolute; top: 30px; right: 30px; width: 240px; pointer-events: auto; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .status-header { font-size: 0.7rem; text-transform: uppercase; color: #888; letter-spacing: 1px; }
        .progress-bar { width: 100%; height: 4px; background: #333; margin-top: 8px; border-radius: 2px; }
        .progress-fill { height: 100%; background: var(--c-widerstand); width: 0%; transition: width 0.5s; box-shadow: 0 0 8px var(--c-widerstand); }
        .lock-text { text-align: right; font-family: var(--font-head); font-size: 0.9rem; color: #666; margin-top: 5px; }

        #legend { position: absolute; bottom: 30px; left: 30px; pointer-events: auto; display: flex; flex-direction: column; gap: 8px; }
        .legend-item { display: flex; align-items: center; gap: 10px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #ccc; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }

        /* SIDEBAR */
        #sidebar { position: absolute; right: 0; top: 0; bottom: 0; width: var(--sidebar-width); background: #080808; border-left: 1px solid #333; z-index: 60; transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); overflow-y: auto; pointer-events: auto; display: flex; flex-direction: column; box-shadow: -20px 0 50px rgba(0,0,0,0.8); }
        #sidebar.open { transform: translateX(0); }
        .close-area { position: sticky; top: 0; width: 100%; height: 70px; z-index: 50; display: flex; justify-content: flex-end; align-items: center; padding-right: 25px; background: linear-gradient(to bottom, rgba(8,8,8,1) 50%, rgba(8,8,8,0)); }
        .close-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; width: 44px; height: 44px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .close-btn:hover { background: white; color: black; }
        .sidebar-content { padding: 40px; padding-top: 0; padding-bottom: 80px; }
        .hero-img { width: 100%; height: 300px; object-fit: cover; border-bottom: 4px solid #333; margin-bottom: 25px; }
        .cat-tag { font-family: var(--font-head); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; display: inline-block; padding: 4px 8px; border: 1px solid #444; color: #fff; }
        h2 { font-family: var(--font-head); font-size: 2.2rem; line-height: 1.1; margin: 0 0 25px 0; font-weight: 700; color: white; }
        .article { font-size: 1.05rem; line-height: 1.7; color: #ccc; font-weight: 300; margin-bottom: 40px; }
        .article h3 { color: white; font-family: var(--font-head); font-size: 1.2rem; margin-top: 30px; margin-bottom: 10px; font-weight: 500; border-left: 3px solid var(--c-path); padding-left: 10px; }
        .source { font-size: 0.75rem; color: #666; border-top: 1px solid #222; padding-top: 20px; font-style: italic; }
        .footer-note { margin-top: 30px; padding-top: 20px; border-top: 1px solid #333; color: #888; font-size: 0.9rem; }
        .locked-view { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px; color: #555; }
        .locked-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }

        @media (max-width: 1024px) {
            :root { --sidebar-width: 100%; }
            .sidebar-content { padding: 25px; }
            #mini-scanner { top: 180px; left: 20px; }
        }
        
        .mapboxgl-popup-content { background: #000; color: #fff; border: 1px solid #444; font-family: var(--font-body); padding: 10px 14px; }
        .mapboxgl-popup-close-button { display: none; }
    </style>
</head>
<body class="p-1933">

    <div id="start-screen">
        <h1 style="color:white; margin-bottom: 10px; text-shadow:0 0 20px black;">Orte der Erinnerung, des Widerstands und der Solidarit√§t</h1>
        <p style="color:#aaa; font-family:var(--font-head);">Berlin-Lichtenberg</p>
        <button class="start-btn" onclick="startApp()">Karte Starten</button>
    </div>

    <div id="map"></div>
    <div class="vignette-overlay"></div>

    <div id="ui-layer">
        <header>
            <div class="museum-label">Museum Lichtenberg</div>
            <h1>Orte des<br>Widerstands</h1>
        </header>

        <div id="mini-scanner">
            <div id="reader"></div>
            <div class="scanner-label">SCAN QR</div>
            <div id="scan-hit-overlay" onclick="executeScanAction()">
                <div class="hit-icon">‚ûú</div>
                <div class="hit-text">√ñFFNEN</div>
            </div>
        </div>

        <div id="status-panel">
            <div class="status-header">Fortschritt</div>
            <div class="progress-bar"><div class="progress-fill" id="progress-bar"></div></div>
            <div class="lock-text" id="lock-status">GEGENWART GESPERRT</div>
        </div>

        <div id="legend">
            <div class="legend-item"><div class="dot" style="background:var(--c-erinnerung)"></div> Erinnerung (Opfer)</div>
            <div class="legend-item"><div class="dot" style="background:var(--c-gedenken)"></div> Gedenken (Historisch)</div>
            <div class="legend-item"><div class="dot" style="background:var(--c-widerstand)"></div> Widerstand (Aktuell)</div>
        </div>
    </div>

    <div id="sidebar">
        <div class="close-area"><button class="close-btn" onclick="closeSidebar()">&times;</button></div>
        <div id="sidebar-content"></div>
    </div>

    <script>
        // ------------------------------------------------------------------
        [cite_start]// 1. CONTENT DATABASE (FROM PDF) [cite: 1-208]
        // ------------------------------------------------------------------
        const geoData = {
            'type': 'FeatureCollection',
            'features': [
                // === KATEGORIE 1: ORTE DER ERINNERUNG ===
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'kurt_schneider',
                        'category': 'erinnerung',
                        'title': 'Kurt Schneider (1961‚Äì1999)',
                        'year': 1999,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/0/01/Memorial_plaque_metal_Kurt_Schneider_Berlin%2C_Germany.jpg',
                        'description': `<h3>Opfer rechter Gewalt</h3><p>Kurt Schneider wurde 1961 in K√∂nigs Wusterhausen geboren. Er arbeitete als Maurer. In der Nacht zum 6. Oktober 1999 wurde er von vier Neonazis √ºberfallen, weil sie seinen Gru√ü als "Beleidigung" empfanden. [cite_start]Sie schlugen ihn zusammen, kehrten sp√§ter mit einem Messer zur√ºck und ermordeten ihn [cite: 16-19].</p><h3>Kontext</h3><p>Vor Gericht gaben die T√§ter an, ihn als "minderwertigen Menschen" angesehen zu haben. Das Gericht erkannte zun√§chst kein politisches Motiv. [cite_start]Erst 2018 wurde die Tat durch eine TU-Studie offiziell als rechtsextremer Gewaltakt anerkannt [cite: 21-25][cite_start].</p><h3>Gedenken</h3><p>Am 17.08.2021 wurde eine Edelstahltafel in der Rudolf-Reusch-Stra√üe 8 enth√ºllt[cite: 26].</p>`,
                        'source': 'Gedenktafeln in Berlin - Kurt Schneider'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4802, 52.5185] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'silvio_meier',
                        'category': 'erinnerung',
                        'title': 'Silvio Meier (1965‚Äì1992)',
                        'year': 1992,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/1/14/Silvio_Meier.jpg',
                        'description': `<h3>Aktivist & Opfer</h3><p>Silvio Meier war in der DDR-Opposition aktiv (Kirche von Unten, Umweltbibliothek). [cite_start]Nach der Wende Hausbesetzer in der Schreinerstra√üe 47. Wurde 1992 aufgrund seines antifaschistischen Auftretens von Neonazis ermordet [cite: 35-39][cite_start].</p><h3>Kontext</h3><p>Die Tat wurde vor Gericht entpolitisiert; die T√§ter wurden als "Alkoholmissbrauch treibende Jugendgruppe" bezeichnet[cite: 41].</p><h3>Gedenken</h3><p>J√§hrliche Gedenkdemonstration (1992‚Äì2014). [cite_start]Gedenktafel am U-Bhf Samariterstra√üe und Umbenennung der Gabelsbergerstra√üe in Silvio-Meier-Stra√üe [cite: 46-49].</p>`,
                        'source': 'Amadeu Antonio Stiftung - Silvio Meier'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4658, 52.5144] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'eugeniu_botnari',
                        'category': 'erinnerung',
                        'title': 'Eugeniu Botnari (1982‚Äì2016)',
                        'year': 2016,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/0/03/Gedenktafel_Eugeniu-Botnari-Platz_%28Rumbg%29_Eugeniu_Botnari.jpg',
                        'description': `<h3>Opfer rassistischer Gewalt</h3><p>Wurde am 17. September 2016 vom Filialleiter eines Edeka-Marktes des Ladendiebstahls bezichtigt, in ein Lager gezerrt und mit Quarzhandschuhen verpr√ºgelt. [cite_start]Botnari starb Tage sp√§ter an einem Sch√§del-Hirn-Trauma [cite: 57-61].</p><h3>Kontext</h3><p>Der T√§ter filmte die Tat und teilte sie mit menschenverachtenden Kommentaren. Motiv war Sozialdarwinismus (Hass auf Obdachlose) und Rassismus. [cite_start]Im April 2023 wurde der Platz nach Botnari benannt[cite: 64, 71].</p>`,
                        'source': 'Amadeu Antonio Stiftung - Eugeniu Botnari'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4975, 52.5098] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'kaethe_tucholla',
                        'category': 'erinnerung',
                        'title': 'K√§the Tucholla (1910‚Äì1943)',
                        'year': 1943,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/5/5c/Kaskelkiez_Kaskelstr_Gedenktafel_Tucholla.JPG',
                        'description': `<h3>Widerstandsk√§mpferin</h3><p>Sekret√§rin und Hockeyspielerin bei Sparta Lichtenberg. Engagierte sich mit ihrem Mann Felix in der KPD-Widerstandsgruppe um Robert Uhrig. [cite_start]Verbreitete Flugbl√§tter und unterst√ºtzte Fallschirmj√§ger [cite: 78-85].</p><h3>Schicksal</h3><p>Festnahme am 25. Juli 1942. Zum Tode verurteilt wegen "Vorbereitung zum Hochverrat". [cite_start]Ermordet am 28. September 1943 in Pl√∂tzensee [cite: 87-89].</p>`,
                        'source': 'Frauen im Widerstand - K√§the Tucholla'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4832, 52.5038] }
                },

                // === KATEGORIE 3: ORTE DES GEDENKENS (Historisch) ===
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'rummelsburg',
                        'category': 'gedenken',
                        'title': 'Gedenkort Rummelsburg',
                        'year': 1933,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/5/52/Bundesarchiv_Bild_183-1990-0704-026%2C_Berlin%2C_Rummelsburg%2C_M%C3%A4nnerhaftanstalt.jpg',
                        'description': `<h3>Verfolgung von "Asozialen"</h3><p>1879 als Arbeitshaus er√∂ffnet. Im NS-Staat Verfolgung von "Asozialen"; 1941 Deportation j√ºdischer Insassen zur Ermordung (Aktion T4). [cite_start]In der DDR Nutzung als Gef√§ngnis (auch f√ºr politische H√§ftlinge) [cite: 143-152].</p><h3>Status</h3><p>Gedenkort seit 2015; [cite_start]Geb√§ude zu Wohnraum umgebaut[cite: 154].</p>`,
                        'source': 'Memorial Museums - Gedenkort Rummelsburg'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4855, 52.4955] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'rote_kapelle',
                        'category': 'gedenken',
                        'title': 'Die Rote Kapelle',
                        'year': 1940,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/c/ca/Skulptur_Schulze-Boysen-Str_12_%28Liber%29_B%C3%BCrger_im_Widerstand%26Achim_K%C3%BChn%2620112.jpg',
                        'description': `<h3>Widerstandsnetzwerk</h3><p>Gro√ües antifaschistisches Widerstandsnetzwerk (√ºber 150 Personen). [cite_start]Dokumentierten NS-Verbrechen und warnten die Sowjetunion vor Angriffen [cite: 161-166].</p><h3>Verfolgung</h3><p>1942 Verhaftungswelle, √ºber 50 Todesurteile/Ermordungen. [cite_start]Stra√üen und Schulen im Kiez tragen Namen der Mitglieder (Coppi, Harnack, Schulze-Boysen)[cite: 168, 172].</p>`,
                        'source': 'Gedenktafeln in Berlin'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4872, 52.5138] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'loeperplatz',
                        'category': 'gedenken',
                        'title': 'Ehrenmal Loeperplatz',
                        'year': 1948,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/f/fe/Loeperplatz_VDN_1.jpg',
                        'description': `<h3>Opfer des Faschismus</h3><p>Vermutlich 1948 errichtet. [cite_start]Steinquader mit roter Pyramide und den Buchstaben "KZ" (symbolisiert den roten Winkel der politischen H√§ftlinge) [cite: 179-183].</p>`,
                        'source': 'Memorial Museums'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4795, 52.5238] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'rathaus',
                        'category': 'gedenken',
                        'title': 'Gedenktafel Rathaus Lichtenberg',
                        'year': 1933,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/0/02/Rathaus_Lichtenberg_West-_und_Hauptfassade_2021.jpg',
                        'description': `<h3>Verfolgte Politiker</h3><p>Erinnert an Bezirks- und Stadtverordnete, die 1933 ihrer √Ñmter enthoben wurden. [cite_start]Darunter Frieda Rosenthal (Suizid in Haft) und Johannes Fest (Berufsverbot) [cite: 196-206].</p>`,
                        'source': 'Bezirksamt Lichtenberg'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4798, 52.5155] }
                },

                // === KATEGORIE 2: ORTE DES WIDERSTANDS (Aktuell) ===
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'bunter_wind',
                        'category': 'widerstand',
                        'title': 'Bunter Wind f√ºr Lichtenberg',
                        'year': 2012,
                        'locked': true,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/2/2e/Rathaus_Lichtenberg.jpg', // Placeholder used due to no specific img in PDF
                        'description': `<h3>Seit 2012</h3><p>Setzt Impulse f√ºr eine offene, demokratische Gesellschaft. [cite_start]St√§rkt Zusammenhalt und Solidarit√§t gegen Diskriminierung und Ausgrenzung [cite: 93][cite_start].</p><h3>Motto</h3><p>"Solidarisch f√ºr eine starke und lebendige Demokratie!" [cite: 95]</p>`,
                        'source': 'Bunter Wind f√ºr Lichtenberg'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.5055, 52.5115] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'licht_blicke',
                        'category': 'widerstand',
                        'title': 'Licht-Blicke',
                        'year': 2002,
                        'locked': true,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/e/e5/Gudrunstra%C3%9Fe_Berlin-Lichtenberg.jpg', // Placeholder location img
                        'description': `<h3>Seit 2002</h3><p>Netzwerkstelle f√ºr Demokratiepartnerschaften. [cite_start]Schnittstelle zwischen Politik, Verwaltung und Zivilgesellschaft [cite: 107][cite_start].</p><h3>Aufgaben</h3><p>Unterst√ºtzung lokalen Engagements gegen Rechts, F√∂rderung von Diversit√§tsbewusstsein, Koordinierung der Stolperstein-Verlegung und Jugendpartizipation [cite: 110-119].</p>`,
                        'source': 'Licht Blicke'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.5205, 52.4962] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'berliner_register',
                        'category': 'widerstand',
                        'title': 'Berliner Register',
                        'year': 2005,
                        'locked': true,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/0/02/Rathaus_Lichtenberg_West-_und_Hauptfassade_2021.jpg', // Placeholder location img
                        [cite_start]'description': `<h3>Seit 2005</h3><p>Dokumentation von Diskriminierung und Ausgrenzung im Alltag (rassistisch, antisemitisch, rechts, etc.)[cite: 124].</p><h3>Methode</h3><p>B√ºrger:innen melden Vorf√§lle (auch solche, die keine Straftaten sind, wie Aufkleber oder Spr√ºche). [cite_start]Diese werden in einer Chronik ver√∂ffentlicht, um Ausgrenzung sichtbar zu machen [cite: 126-127].</p>`,
                        'source': 'Berliner Register'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.5055, 52.5115] }
                }
            ]
        };

        // ------------------------------------------------------------------
        // APP LOGIC (NO-FAIL START)
        // ------------------------------------------------------------------
        function startApp() {
            // 1. Hide Overlay IMMEDIATELY
            const overlay = document.getElementById('start-screen');
            overlay.style.opacity = '0';
            setTimeout(() => { overlay.style.display = 'none'; }, 500);

            // 2. Initialize Mapbox
            initMap();

            // 3. Try Scanner (Silent fail if not allowed)
            setTimeout(initScanner, 1000);
        }

        mapboxgl.accessToken = 'pk.eyJ1IjoiaWxpYXNtZXJhYmloYSIsImEiOiJjbWxndXhkeHYwMjZwM2RxdmlmbW41MmVlIn0.pb_GFtsw_uGl7eOkRZfKvw'; // <--- TOKEN HIER EINF√úGEN!

        let map;
        let state = { discovered: [], required: 3, unlocked: false, scanner: null, lastScannedId: null };

        function initMap() {
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/dark-v11',
                center: [13.485, 52.51], zoom: 12.5, pitch: 45
            });

            map.on('load', () => {
                // Add Content to Map
                map.addSource('markers', { 'type': 'geojson', 'data': geoData });
                
                // Glow Layer
                map.addLayer({ 
                    'id': 'marker-glow', 'type': 'circle', 'source': 'markers', 
                    'paint': { 
                        'circle-radius': 70, 
                        'circle-color': ['match', ['get', 'category'], 'erinnerung', '#D4AF37', 'gedenken', '#A0A0A0', 'widerstand', '#00E676', '#fff'], 
                        'circle-opacity': 0.5, 'circle-blur': 0.5 
                    } 
                });
                
                // Core Layer
                map.addLayer({ 
                    'id': 'marker-core', 'type': 'circle', 'source': 'markers', 
                    'paint': { 'circle-radius': 10, 'circle-color': '#fff', 'circle-stroke-width': 2, 'circle-stroke-color': '#000' } 
                });

                // Interactions
                map.on('click', 'marker-core', (e) => handleMarker(e.features[0].properties, e.features[0].geometry.coordinates));
                map.on('mouseenter', 'marker-core', () => map.getCanvas().style.cursor = 'pointer');
                map.on('mouseleave', 'marker-core', () => map.getCanvas().style.cursor = '');
                
                // 3D Buildings
                const layers = map.getStyle().layers;
                const labelLayerId = layers.find(l => l.type === 'symbol' && l.layout['text-field']).id;
                map.addLayer({ 'id': '3d-buildings', 'source': 'composite', 'source-layer': 'building', 'filter': ['==', 'extrude', 'true'], 'type': 'fill-extrusion', 'paint': { 'fill-extrusion-color': '#222', 'fill-extrusion-height': ['get', 'height'], 'fill-extrusion-opacity': 0.9 } }, labelLayerId);
            });
        }

        function handleMarker(props, coords) {
            if (props.locked && !state.unlocked) { openSidebarLocked(); return; }
            if (!state.discovered.includes(props.id) && !props.locked) { state.discovered.push(props.id); updateProgress(); }
            
            map.flyTo({ center: coords, zoom: 16, pitch: 60, offset: [0, -200], speed: 0.8 });
            openSidebar(props);
        }

        function updateProgress() {
            const pct = Math.min((state.discovered.length / state.required) * 100, 100);
            document.getElementById('progress-bar').style.width = pct + '%';
            if (state.discovered.length >= state.required && !state.unlocked) { setTimeout(unlockAll, 1000); }
        }

        function unlockAll() {
            state.unlocked = true;
            document.getElementById('lock-status').innerText = "FREIGESCHALTET";
            document.getElementById('lock-status').style.color = "#00E676";
            document.getElementById('progress-bar').style.background = "#00E676";
            alert("GESCHICHTE ERFORSCHT - GEGENWART FREIGESCHALTET!");
        }

        // --- SCANNER LOGIC ---
        function initScanner() {
            try {
                if(!state.scanner) state.scanner = new Html5Qrcode("reader");
                state.scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 80 }, onScanSuccess)
                .catch(err => console.log("Scanner stumm geschaltet (Permission?):", err));
            } catch(e) {}
        }

        function onScanSuccess(decodedText) {
            let foundId = null;
            for(let f of geoData.features) {
                if(decodedText.includes(f.properties.id)) { foundId = f.properties.id; break; }
            }
            if(foundId && foundId !== state.lastScannedId) {
                state.lastScannedId = foundId;
                state.scanner.pause();
                document.getElementById('scan-hit-overlay').style.display = 'flex';
                document.getElementById('mini-scanner').style.borderColor = "#00E676";
            }
        }

        function executeScanAction() {
            const id = state.lastScannedId;
            const feature = geoData.features.find(f => f.properties.id === id);
            if(feature) handleMarker(feature.properties, feature.geometry.coordinates);
            
            setTimeout(() => {
                document.getElementById('scan-hit-overlay').style.display = 'none';
                document.getElementById('mini-scanner').style.borderColor = "#444";
                state.lastScannedId = null;
                state.scanner.resume();
            }, 1000);
        }

        // --- SIDEBAR UI ---
        function openSidebar(data) {
            const content = document.getElementById('sidebar-content');
            const colors = { 'erinnerung': '#D4AF37', 'gedenken': '#A0A0A0', 'widerstand': '#00E676' };
            content.innerHTML = `
                <img src="${data.image}" class="hero-img">
                <div class="sidebar-content">
                    <span class="cat-tag" style="border-color:${colors[data.category]}; color:${colors[data.category]}">${data.category.toUpperCase()}</span>
                    <h2>${data.title}</h2>
                    <div class="article">${data.description}</div>
                    <div class="source">Quelle: ${data.source} ‚Ä¢ Jahr: ${data.year}</div>
                    [cite_start]<div class="footer-note">Anlaufstellen f√ºr Opfer rechter Gewalt: Reach Out Berlin [cite: 208]</div>
                </div>`;
            document.getElementById('sidebar').classList.add('open');
        }

        function openSidebarLocked() {
            document.getElementById('sidebar-content').innerHTML = `<div class="locked-view"><div class="locked-icon">üîí</div><h2 style="color:#FF3D00">DATEN VERSCHL√úSSELT</h2><p>Erforsche erst die Geschichte.</p></div>`;
            document.getElementById('sidebar').classList.add('open');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            map.easeTo({ offset: [0, 0] });
        }
    </script>
</body>
</html>
